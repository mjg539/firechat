<template>
  <div>
  <div class = "conversation" id = "conversation">
    <b class="lightgreen">Conversation ID:</b> {{ id }} 
    <Message 
      :displayUser="displayUser"
      v-for="message in conversation.messages" 
      :message="message" 
      :key="message.created" 
    />
    </div>
    <br />
    <input class="input" v-model="newMessageText" @keyup.enter="send" id="inputField" placeholder="Type something..." />
  </div>
</template>

<script>
  import Message from './Message.vue'
  import { mapState } from 'vuex'

  export default {
    name: 'ConversationContainer',

    data () {
      return {
        newMessageText: ''
      }
    },

    props: {
      conversation: {
        type: Object,
        required: true
      },
      id: {
        type: String,
        required: true
      },
      displayUser: String,
    },

    created () {
      this.$store.state.db.collection('conversations').doc(this.id).onSnapshot(convo => {
        let source = convo.metadata.hasPendingWrites ? 'Local' : 'Server'

        console.log(`Source ${source}`)

        if (convo && convo.data()) {
          convo.data().messages.forEach(message => this.$store.commit('conversations/ADD_MESSAGE', { 
            conversationId: this.id, message })
          )
        }
      })
    },
    methods: {
      send () {
        this.$store.dispatch('conversations/sendMessage', { 
          text: this.newMessageText, 
          created: Date.now(),
          conversationId: this.id,
          sender: this.$store.state.users.currentUser,
          displayUser: this.displayUser,
        })
        this.clear();
        this.scroll();
      },
      clear () {
        this.newMessageText = '';
      },
      scroll () {
        var element = document.getElementById("conversation");
        element.scrollTop = element.scrollHeight;
        setTimeout(1000);
      },
    },

    components: {
      Message
    }
  }
</script>

<style>
</style>

